configfile: 'config/mvp.yml'

bids_dir = config['bids_dir']
output_dir = config['output_dir']
script_dir = config['script_dir']
session = config['sessions']
subject = config['subjects']


rule proc_structural:
    input:
        f"{bids_dir}/sub-{subject}/ses-{session}/anat/sub-{subject}_ses-{session}_{config['parameters']['proc_structural']['T1wStr']}.nii.gz",
    output:
        processed_volumetric=f"{output_dir}/sub-{{subject}}/ses-{{session}}/anat/processed_volumetric.nii.gz",
    params:
        tmpDir="tmp",
        T1wStr=config["parameters"]["proc_structural"].get("T1wStr", "T1w.nii"),
        UNI=config["parameters"]["proc_structural"].get("UNI", "FALSE"),
        MF=config["parameters"]["proc_structural"].get("MF", 3),
        subject_short="{subject}",
        session_short="ses-{wildcards.session}",
    threads: config.get("threads", 4),
    shell:
        """
        echo "Running structural processing with subject={wildcards.subject} session={wildcards.session}, full_subject={params.subject_short}, full_session={params.session_short}"
        bash {script_dir}/01_proc-structural.sh \
            {bids_dir} {params.subject_short} {output_dir} -ses {params.session_short} \
            --threads {threads} --tmpDir {params.tmpDir} --T1wStr {params.T1wStr} --uni {params.UNI} --mf {params.MF}
        """
